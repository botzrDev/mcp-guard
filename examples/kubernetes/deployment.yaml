apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-guard
  labels:
    app: mcp-guard
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mcp-guard
  template:
    metadata:
      labels:
        app: mcp-guard
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: mcp-guard
          image: ghcr.io/botzrdev/mcp-guard:latest
          ports:
            - containerPort: 3000
              name: http
          env:
            - name: RUST_LOG
              value: "info"
          args:
            - "run"
            - "--config"
            - "/config/mcp-guard.toml"
          volumeMounts:
            - name: config
              mountPath: /config
              readOnly: true
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /live
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
      volumes:
        - name: config
          configMap:
            name: mcp-guard-config
---
apiVersion: v1
kind: Service
metadata:
  name: mcp-guard
  labels:
    app: mcp-guard
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 3000
      protocol: TCP
      name: http
  selector:
    app: mcp-guard
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mcp-guard-config
data:
  mcp-guard.toml: |
    [server]
    host = "0.0.0.0"
    port = 3000

    [upstream]
    transport = "http"
    url = "http://mcp-server:8080/mcp"

    [[auth.api_keys]]
    id = "k8s-agent"
    # Store actual hash in a Secret and mount it, or use environment variable
    key_hash = "YOUR_KEY_HASH_HERE"
    allowed_tools = []

    [rate_limit]
    enabled = true
    requests_per_second = 100
    burst_size = 50

    [audit]
    enabled = true
    stdout = true

    [tracing]
    enabled = true
    service_name = "mcp-guard"
    otlp_endpoint = "http://jaeger-collector:4317"
    sample_rate = 0.1
